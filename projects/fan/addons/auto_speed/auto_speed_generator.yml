defaults:
  icon: mdi:speedometer-medium
  
  requires:
    ident: 3
    min:
    max:
    step: 1
  first: false
  last: false
  lambda_fudge:
    inc: !lambda return x + ${step};
    dec: !lambda return x - ${step};
    recheck_threashold: !lambda id(${fan}_auto_thresh_${ident}).publish_state( id(${temp_sensor}).state >= x );
    less_than: !lambda return x <= id(${fan}_auto_${ident-1}).state;
    greater_than: !lambda return x >= id(${fan}_auto_${ident+1}).state;
  test_lambda: "return x {0} id({1}_auto_{2}).state;"
  number_id: "{0}_auto_{1}"

sensor:
  - id: !extend ${fan}_wanted_auto_speed
    channels:
      - binary_sensor: ${fan}_auto_thresh_${ident}
        value: 1.0

binary_sensor:
  - id: ${fan}_auto_thresh_${ident}
    platform: analog_threshold
    sensor_id: ${temp_sensor}
    threshold: !lambda return id(${fan}_auto_${ident}).state;

number:
  - platform: template
    restore_value: true
    entity_category: config
    min_value: ${min}
    max_value: ${max}
    step: ${step}
    device_class: TEMPERATURE
    unit_of_measurement: Â°C
    optimistic: true
    mode: box
    id: ${fan}_auto_${ident}
    name: Auto Speed ${ident} Temperature
    initial_value: ${default}
#    icon: ${icon}
    set_action: |-
      <% set actions = [{"lambda": lambda_fudge.recheck_threashold}] %>
      <% if not first %>
        <%
          set actions = actions+ [
            {
              "if": {
                "condition": {"lambda": lambda_fudge.less_than},
                "then": {
                  "number.set": {
                    "id": number_id.format(fan,ident-1),
                    "value": lambda_fudge.dec
                  }
                }
              }
            }
          ]
        %>
      <% endif %>
      <% if not last %>
        <%
          set actions = actions+ [
            {
              "if": {
                "condition": {"lambda": lambda_fudge.greater_than},
                "then": {
                  "number.set": {
                    "id": number_id.format(fan,ident+1),
                    "value": lambda_fudge.inc
                  }
                }
              }
            }
          ]
        %>
      <% endif %>
      ${actions}

#    - if:
#          condition:
#            lambda: return x ${${type}_t} id(${fan}_auto_${link}).state;
#          then:
#            - number.set:
#                id: ${fan}_auto_${link}
#                value: !lambda return x ${${type}_a} 1;

      
      
#    - if:
#        condition:
#          lambda: return x ${${type}_t} id(${fan}_auto_${link}).state;
#        then:
#          - number.set:
#              id: ${fan}_auto_${link}
#              value: !lambda return x ${${type}_a} 1;